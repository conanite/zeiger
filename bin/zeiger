#!/usr/bin/env ruby

require 'socket'
require 'zeiger'

SOCKET_NAME = "./zeiger-index"

command = $*[0]

class Server
  def self.run
    dir = File.expand_path(".")
    z = Zeiger::Index.new dir

    Thread.new do
      begin
        puts "monitor thread"
        monitor = Zeiger::Monitor.new dir, z
        puts "created monitor"
        while true do
          puts "scanning..."
          monitor.build_index
          sleep 10
        end
      rescue Exception => e
        puts e.message
        puts e.backtrace
      end
    end

    puts "query thread..."

    Socket.unix_server_loop(SOCKET_NAME) { |sock, client|
      puts "query thread: server loop"
      begin
        z.query(sock.readline.strip).each { |res| sock.puts res.to_s }
      ensure
        sock.close
      end
    }
  end
end

class Client
  def self.run q
    Socket.unix(SOCKET_NAME) { |sock|
      sock.puts(q)
      sleep(1)
      while !sock.eof?
        puts sock.readline
      end
    }
  end
end

case command
when "server" ; Server.run
when "search" ; Client.run($*[1])
end

# define file groups

# file_group :app, patterns: [/^app/ ]
# file_group :helpers, patterns: [/^app\/helpers/ ]
# file_group :spec, patterns: [/^spec/ ]
# file_group :sass, patterns: [/\.sass$/ ]
# file_group :all, groups: %w{app spec sass}


# writing to socket: nc -U /tmp/uss
